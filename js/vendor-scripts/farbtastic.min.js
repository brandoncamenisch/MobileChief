// Farbtastic 2.0 alpha
(function(e){var t=!1;e.fn.farbtastic=function(t){e.farbtastic(this,t);return this};e.farbtastic=function(t,n){var t=e(t)[0];return t.farbtastic||(t.farbtastic=new e._farbtastic(t,n))};e._farbtastic=function(n,r){var s=this;s.linkTo=function(t){typeof s.callback=="object"&&e(s.callback).unbind("keyup",s.updateValue);s.color=null;if(typeof t=="function")s.callback=t;else if(typeof t=="object"||typeof t=="string"){s.callback=e(t);s.callback.bind("keyup",s.updateValue);s.callback[0].value&&s.setColor(s.callback[0].value)}return this};s.updateValue=function(e){this.value&&this.value!=s.color&&s.setColor(this.value)};s.setColor=function(e){var t=s.unpack(e);if(s.color!=e&&t){s.color=e;s.rgb=t;s.hsl=s.RGBToHSL(s.rgb);s.updateDisplay()}return this};s.setHSL=function(e){s.hsl=e;s.rgb=s.HSLToRGB(e);s.color=s.pack(s.rgb);s.updateDisplay();return this};s.initWidget=function(){var t={width:r.width,height:r.width};e(n).html('<div class="farbtastic" style="position: relative"><div class="farbtastic-solid"></div><canvas class="farbtastic-mask"></canvas><canvas class="farbtastic-overlay"></canvas></div>').find("*").attr(t).css(t).end().find("div>*").css("position","absolute");e.browser.msie&&e("canvas",n).each(function(){var n={"class":e(this).attr("class"),style:this.getAttribute("style")},r=document.createElement("canvas");e(this).before(e(r).attr(n)).remove();G_vmlCanvasManager&&G_vmlCanvasManager.initElement(r);e(r).attr(t).css(t).css("position","absolute").find("*").attr(t).css(t)});s.radius=(r.width-r.wheelWidth)/2-1;s.square=Math.floor((s.radius-r.wheelWidth/2)*.7)-1;s.mid=Math.floor(r.width/2);s.markerSize=r.wheelWidth*.3;s.solidFill=e(".farbtastic-solid",n).css({width:s.square*2-1,height:s.square*2-1,left:s.mid-s.square,top:s.mid-s.square});s.cnvMask=e(".farbtastic-mask",n);s.ctxMask=s.cnvMask[0].getContext("2d");s.cnvOverlay=e(".farbtastic-overlay",n);s.ctxOverlay=s.cnvOverlay[0].getContext("2d");s.ctxMask.translate(s.mid,s.mid);s.ctxOverlay.translate(s.mid,s.mid);s.drawCircle();s.drawMask()};s.drawCircle=function(){var n=+(new Date),i=24,o=s.radius,u=r.wheelWidth,a=8/o/i*Math.PI,f=s.ctxMask,l=0,c,h;f.save();f.lineWidth=u/o;f.scale(o,o);for(var p=0;p<=i;++p){var d=p/i,v=d*Math.PI*2,m=Math.sin(l),g=-Math.cos(l);x2=Math.sin(v),y2=-Math.cos(v),am=(l+v)/2,tan=1/Math.cos((v-l)/2),xm=Math.sin(am)*tan,ym=-Math.cos(am)*tan,color2=s.pack(s.HSLToRGB([d,1,.5]));if(p>0)if(e.browser.msie){var y=(1+Math.min(Math.abs(Math.tan(l)),Math.abs(Math.tan(Math.PI/2-l))))/i;c=s.pack(s.HSLToRGB([h-.15*y,1,.5]));color2=s.pack(s.HSLToRGB([d+.15*y,1,.5]));var b=f.createLinearGradient(m,g,x2,y2);b.addColorStop(0,c);b.addColorStop(1,color2);f.fillStyle=b;var w=(o+u/2)/o,E=(o-u/2)/o;f.beginPath();f.moveTo(m*w,g*w);f.quadraticCurveTo(xm*w,ym*w,x2*w,y2*w);f.lineTo(x2*E,y2*E);f.quadraticCurveTo(xm*E,ym*E,m*E,g*E);f.fill()}else{var b=f.createLinearGradient(m,g,x2,y2);b.addColorStop(0,c);b.addColorStop(1,color2);f.strokeStyle=b;f.beginPath();f.moveTo(m,g);f.quadraticCurveTo(xm,ym,x2,y2);f.stroke()}l=v-a;c=color2;h=d}f.restore();t&&e("body").append("<div>drawCircle "+(+(new Date)-n)+"ms")};s.drawMask=function(){function o(e,t,n){var r=1/e,i=1/t;for(var s=0;s<=t;++s){var o=1-s*i;for(var u=0;u<=e;++u){var a=1-u*r,f=1-2*Math.min(o*a,(1-o)*a),l=f>0?(2*o-1+f)*.5/f:0;n(u,s,l,f)}}}var n=+(new Date),r=s.square*2,i=s.square;if(s.ctxMask.getImageData){var u=Math.floor(r/2),a=document.createElement("canvas");a.width=a.height=u+1;var f=a.getContext("2d"),l=f.getImageData(0,0,u+1,u+1),c=0;o(u,u,function(e,t,n,r){l.data[c++]=l.data[c++]=l.data[c++]=n*255;l.data[c++]=r*255});f.putImageData(l,0,0);s.ctxMask.drawImage(a,0,0,u+1,u+1,-i,-i,i*2,i*2)}else if(!e.browser.msie){var u=Math.floor(r/2);o(u,u,function(e,t,n,r){n=Math.round(n*255);s.ctxMask.fillStyle="rgba("+n+", "+n+", "+n+", "+r+")";s.ctxMask.fillRect(e*2-i-1,t*2-i-1,2,2)})}else{var h,p,d=6,v=Math.floor(r/d);o(v,6,function(t,n,r,o){if(t==0){h=p;p=[]}r=Math.round(r*255);o=Math.round(o*255);if(n>0){var u=h[t][0],a=h[t][1],f=s.packDX(u,a),l=s.packDX(r,o),c=Math.round(s.mid+((n-1)*.333-1)*i),m=Math.round(s.mid+(n*.333-1)*i);e("<div>").css({position:"absolute",filter:"progid:DXImageTransform.Microsoft.Gradient(StartColorStr="+f+", EndColorStr="+l+", GradientType=0)",top:c,height:m-c,left:s.mid+(t*d-i-1),width:d-(t==v?Math.round(d/2):0)}).appendTo(s.cnvMask)}p.push([r,o])})}t&&e("body").append("<div>drawMask "+(+(new Date)-n)+"ms")};s.drawMarkers=function(){var e=r.width,t=Math.ceil(s.markerSize/4),n=s.markerSize-t+1,o=s.hsl[0]*6.28,u=Math.sin(o)*s.radius,a=-Math.cos(o)*s.radius,f=2*s.square*(.5-s.hsl[1]),l=2*s.square*(.5-s.hsl[2]),c=s.invert?"#fff":"#000",h=s.invert?"#000":"#fff",p=[{x:u,y:a,r:n,c:"#000",lw:t+1},{x:u,y:a,r:s.markerSize,c:"#fff",lw:t},{x:f,y:l,r:n,c:h,lw:t+1},{x:f,y:l,r:s.markerSize,c:c,lw:t}];s.ctxOverlay.clearRect(-s.mid,-s.mid,e,e);for(i in p){var d=p[i];s.ctxOverlay.lineWidth=d.lw;s.ctxOverlay.strokeStyle=d.c;s.ctxOverlay.beginPath();s.ctxOverlay.arc(d.x,d.y,d.r,0,Math.PI*2,!0);s.ctxOverlay.stroke()}};s.updateDisplay=function(){s.invert=s.rgb[0]*.3+s.rgb[1]*.59+s.rgb[2]*.11<=.6;s.solidFill.css("backgroundColor",s.pack(s.HSLToRGB([s.hsl[0],1,.5])));s.drawMarkers();if(typeof s.callback=="object"){e(s.callback).css({backgroundColor:s.color,color:s.invert?"#fff":"#000"});e(s.callback).each(function(){typeof this.value=="string"&&this.value!=s.color&&(this.value=s.color)})}else typeof s.callback=="function"&&s.callback.call(s,s.color)};s.widgetCoords=function(e){return{x:e.pageX-s.offset.left-s.mid,y:e.pageY-s.offset.top-s.mid}};s.mousedown=function(t){if(!e._farbtastic.dragging){e(document).bind("mousemove",s.mousemove).bind("mouseup",s.mouseup);e._farbtastic.dragging=!0}s.offset=e(n).offset();var r=s.widgetCoords(t);s.circleDrag=Math.max(Math.abs(r.x),Math.abs(r.y))>s.square+2;s.mousemove(t);return!1};s.mousemove=function(e){var t=s.widgetCoords(e);if(s.circleDrag){var n=Math.atan2(t.x,-t.y)/6.28;s.setHSL([(n+1)%1,s.hsl[1],s.hsl[2]])}else{var r=Math.max(0,Math.min(1,-(t.x/s.square/2)+.5)),i=Math.max(0,Math.min(1,-(t.y/s.square/2)+.5));s.setHSL([s.hsl[0],r,i])}return!1};s.mouseup=function(){e(document).unbind("mousemove",s.mousemove);e(document).unbind("mouseup",s.mouseup);e._farbtastic.dragging=!1};s.dec2hex=function(e){return(e<16?"0":"")+e.toString(16)};s.packDX=function(e,t){return"#"+s.dec2hex(t)+s.dec2hex(e)+s.dec2hex(e)+s.dec2hex(e)};s.pack=function(e){var t=Math.round(e[0]*255),n=Math.round(e[1]*255),r=Math.round(e[2]*255);return"#"+s.dec2hex(t)+s.dec2hex(n)+s.dec2hex(r)};s.unpack=function(e){if(e.length==7){function t(t){return parseInt(e.substring(t,t+2),16)/255}return[t(1),t(3),t(5)]}if(e.length==4){function t(t){return parseInt(e.substring(t,t+1),16)/15}return[t(1),t(2),t(3)]}};s.HSLToRGB=function(e){var t,n,r,i,s,o=e[0],u=e[1],a=e[2];n=a<=.5?a*(u+1):a+u-a*u;t=a*2-n;return[this.hueToRGB(t,n,o+.33333),this.hueToRGB(t,n,o),this.hueToRGB(t,n,o-.33333)]};s.hueToRGB=function(e,t,n){n=(n+1)%1;return n*6<1?e+(t-e)*n*6:n*2<1?t:n*3<2?e+(t-e)*(.66666-n)*6:e};s.RGBToHSL=function(e){var t=e[0],n=e[1],r=e[2],i=Math.min(t,n,r),s=Math.max(t,n,r),o=s-i,u=0,a=0,f=(i+s)/2;f>0&&f<1&&(a=o/(f<.5?2*f:2-2*f));if(o>0){s==t&&s!=n&&(u+=(n-r)/o);s==n&&s!=r&&(u+=2+(r-t)/o);s==r&&s!=t&&(u+=4+(t-n)/o);u/=6}return[u,a,f]};r.callback||(r={callback:r});r=e.extend({width:300,wheelWidth:(r.width||300)/10,callback:null},r);s.initWidget();e("canvas.farbtastic-overlay",n).mousedown(s.mousedown);r.callback&&s.linkTo(r.callback)}})(jQuery);